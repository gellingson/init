{% extends "listings/carbyrbase.html" %}
{% load staticfiles %}
{% block title %}Carbyr: enthusiast search{% endblock title %}
{% block page %}
	<div class="container">
{% block header %}
	<div class="page-header">
	  {% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}
	  <form class="searchform" role="form" action="{{ abs_url }}" method="get">
		<ul class="nav nav-tabs" role="tablist">
		  <li class="active"><a href="#simple" role="tab" data-toggle="tab">Simple</a></li>
		  <li><a href="#advanced" role="tab" data-toggle="tab">Advanced</a></li>
		  <li><a href="#saved" role="tab" data-toggle="tab">Saved</a></li>
		</ul>
		<div class="tab-content">
		  <div class="tab-pane active" id="simple">
			{% csrf_token %}
			<div class="form-group">
			  <div class="input-group">
				<label class="sr-only" for="query_string">Search criteria:</label>
				<input type="text" placeholder="find me..." class="form-control search-sync" name="query_string" id="query_string"/>
				<span class="input-group-btn">
				  <button type="submit" class="btn btn-success">Search</button>
				</span>
			  </div>
			</div>
		  </div>
		  <div class="tab-pane" id="advanced">
			{% csrf_token %}
			<div class="form-group">
			  <div class="input-group">
				<label class="sr-only" for="query_string_dup">Search criteria:</label>
				<input type="text" placeholder="find me..." class="form-control search-sync" name="query_string_dup" id="query_string_dup"/>
				<span class="input-group-btn">
				  <button type="submit" class="btn btn-success">Search</button>
				</span>
			  </div>
			</div>
			<div class="col-sm-4">
			  <input type="checkbox" class="checkbox-inline" name="limit" id="limit"/>
			  <label for="limit" class="label-between">Limit to cars near</label>
			  <label for="zip" class="sr-only">zipcode</label>
 			  <input type="text" class="zip" placeholder="zip code" class="form-control" name="zip" id="zip" size="20"/>
			</div>
			<div class="col-sm-4">
			  <p><i>Many more options coming soon...</i></p>
			</div>
		  </div>
		  <div class="tab-pane" id="saved">
			{% if favorites %}
			<h5>Favorite Searches</h5>
			{% for search in favorites %}
			<a class="btn btn-default" href="{{ abs_url }}?s={{ search.ref }}"><span class="glyphicon glyphicon-heart"></span>{{ search.descr }}</a>
			{% endfor %}
			{% endif %}
			{% if recents %}
			<h5>Recent Searches</h5>
			{% for search in recents %}
			<a class="btn btn-default" href="{{ abs_url }}?s={{ search.ref }}"><span class="glyphicon glyphicon-time"></span>{{ search.descr }}</a>
			{% endfor %}
			{% endif %}
			{% if more_recents %}
			<div class="btn-group">
			  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
				More Recents... <span class="caret"></span>
			  </button>
			  <ul class="dropdown-menu" role="menu">
				{% for search in more_recents %}
				<li><a href="{{ abs_url }}?s={{ search.ref }}">{{ search.descr }}</a></li>
				{% endfor %}
			  </ul>
			</div>
			{% endif %}
			{% if suggestions %}
			<h5>More Ideas</h5>
			{% for search in suggestions %}
			<a class="btn btn-default" href="{{ abs_url }}?s={{ search.ref }}"><span class="glyphicon glyphicon-ok-circle"></span>{{ search.descr }}</a>
			{% endfor %}
			{% endif %}
		  </div>
		</div>
	  </form>
	</div>
	<div class="row header-row">
	  <div class="col-md-8">
		{% if query_type == 'F' %}Favorite search:{% else %}Showing:{% endif %} {{ query_descr }}
	  </div>
	  <div class="col-md-4">
		{% if query_ref %}
		{% if query_type == 'F' %}
		<button class="btn-link" data-toggle="modal" data-target="#unSaveModal">
		  <span class="glyphicon glyphicon-minus"></span>Remove <span class="long">this search from your favorites</span>
		</button>
		{% elif query_type != 'D' %}
		<button class="btn-link" data-toggle="modal" data-target="#saveModal">
		  <span class="glyphicon glyphicon-plus"></span>Save <span class="long">this search as a favorite</span>
		</button>
		{% endif %}
		{% endif %}
	  </div>
	</div>
	<div class="row">
	</div>
	<div class="row">
	  <div class="col-md-8">
		<div class="btn-group" data-toggle="buttons">
		  <label class="btn btn-primary {%if not newonly %}active{% endif %}">
			<input type="radio" name="options" id="option1" href="/cars" autocomplete="off" checked/>All listings
		  </label>
		  <label class="btn btn-primary {%if newonlt %}active{% endif %}">
			<input type="radio" name="options" id="option2" autocomplete="off"/> New listings only
		  </label>
		</div>
		<button class="btn btn-default" data-toggle="modal" data-target="#markReadModal">
		  <span class="glyphicon glyphicon-ok"></span>Mark as seen
		</button>
	  </div>
	</div>
	<hr size="1" style="clear: both;" />
{% endblock header %}
{% block listings %}
	<div class="listings">
	  {% if listings %}
	  {% for item in listings %}
	  <div class="row listing-row" id="{{ item.id }}">
		<a href="{{ item.listing_href }}">
		  <div class="col-md-4 listing">
			<div class="imgcropper">
			  {% if item.since == 'New' %}
			  <img src="{% static 'listings/images/logosmall.png' %}" class="popicon">
			  {% elif item.since == 'Updated' %}
			  <p class="popicon">UPDATED</p>
			  {% endif %}
			  {% if item.pic_href %}
			  <img class="img-rounded" src='{{ item.pic_href }}'>
			  {% else %}
			  <p> No photo available. </p>
			  {% endif %}
			</div>
		  </div>
		  <div class="col-md-3 listing">
			<p><strong>{{ item.model_year }} {{ item.make }} {{ item.model }}</strong></p>
			<p><strong>{{ item.price }}</strong></p>
			{% if item.location_text %}
			<p>{{item.location_text}} ({{ item.source }})</p>
			{% else %}
			<p>({{ item.source }})</p>
			{% endif %}
			{% if item.status != 'F' %}
			<p><strong>This listing {{ item.pretty_status }}</strong></p>
			{% endif %}
			<p></p>
		  </div>
		  <div class="{% if user.is_authenticated %}col-md-4{% else %}col-md-5{% endif %} listing">
			{{ item.listing_text }}
		  </div>
		</a>
		{% if user.is_authenticated %}
		<div class="col-md-1 listing">
		  <button class="btn-link addfav{% if item.favorite %} hidden{% endif %}" listing_id="{{ item.id }}" title="{{ item.model_year }} {{ item.make }} {{ item.model }}"><span class="glyphicon glyphicon-heart wideglyph"></span></button>
		  <button class="btn-link editnote{% if not item.favorite %} hidden{% endif %}" listing_id="{{ item.id }}" title="{{ item.model_year }} {{ item.make }} {{ item.model }}"><span class="glyphicon glyphicon-pencil wideglyph"></span></button>
		  <button class="btn-link unfav{% if not item.favorite %} hidden{% endif %}" listing_id="{{ item.id }}" title="{{ item.model_year }} {{ item.make }} {{ item.model }}"><span class="glyphicon glyphicon-trash wideglyph"></span></button>
		  <button class="btn-link flag" listing_id="{{ item.id }}" title="{{ item.model_year }} {{ item.make }} {{ item.model }}"><span class="glyphicon glyphicon-thumbs-down wideglyph"></span></button>
		</div>
		{% endif %}
		{% if item.favorite %}
		<div class="noteframe{% if not item.note %} hidden{% endif %}">
		  <div class="col-md-12">
		  </div>
		  <a class="editnote" listing_id="{{ item.id }}" title="{{ item.model_year }} {{ item.make }} {{ item.model }}">
			<div class="col-md-1">
			  <p><strong>Notes:</strong></p>
			</div>
			<div class="col-md-10">
			  <pre class="note">{{ item.note }}</pre>
			</div>
		  </a>
		</div>
		{% endif %}
	  </div>
	  {% endfor %}
	  {% else %}
	  <p>No cars... specify (different) search criteria....</p>
	  {% endif %}
	  {% if next_page_offset %}
	  <div class="hidden">
		<a class="more-listings-link" href="/carsapi/{{ next_page_offset }}/50"></a>
	  </div>
	  {% endif %}
	</div>
{% endblock listings %}
	</div>
{% endblock page %}
{% block extrascripts %}
	<script src="{% static 'listings/js/waypoints.min.js' %}"></script>
	<script src="{% static 'listings/js/waypoints-infinite.min.js' %}"></script>
	<script src="{% static 'listings/js/cars.js' %}"></script>
{% endblock extrascripts %}	
{% block dialogs %}
	<div class="modal fade" id="saveModal" tabindex="-1" role="dialog" aria-labelledby="saveModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
			<h4 class="modal-title" id="saveModalLabel">Save this as a favorite search</h4>
		  </div>
		  <form role="form" action="{{ abs_url }}" method="post">
			<div class="modal-body">
			  <p>Favorite searches make it easy to manage your car search. As suitable cars enter (and leave) the market this list will automatically update; check back any time. </p>
			  <p>You can also choose to receive updates on saved searches through RSS or email [coming soon!].</p>
			  {% csrf_token %}
			  <input type="hidden" name="action" value="save_query"/>
			  <input type="hidden" name="query_ref" value="{{ query_ref }}"/>
			  <div class="modal-input">
				<label class="modal-label" for="query_descr">Name the search:</label>
				<input type="text" value="{{ query_descr }}" name="query_descr" id="query_descr"/>
			  </div>
			</div>
			<div class="modal-footer">
			  <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
			  <button type="submit" class="btn btn-primary">Save</button>
			</div>
		  </form>		
		</div>
	  </div>
	</div>
	<div class="modal fade" id="unSaveModal" tabindex="-1" role="dialog" aria-labelledby="unSaveModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
			<h4 class="modal-title" id="unSaveModalLabel">Confirm</h4>
		  </div>
		  <form role="form" action="{{ abs_url }}" method="post">
			<div class="modal-body">
			  <p>Confirm removing favorite search: {{ query_descr }}? </p>
			  {% csrf_token %}
			  <input type="hidden" name="action" value="unsave_query"/>
			  <input type="hidden" name="query_ref" value="{{ query_ref }}"/>
			</div>
			<div class="modal-footer">
			  <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
			  <button type="submit" class="btn btn-primary">Confirm</button>
			</div>
		  </form>		
		</div>
	  </div>
	</div>
	<div class="modal fade" id="markReadModal" tabindex="-1" role="dialog" aria-labelledby="markReadModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
			<h4 class="modal-title" id="markReadModalLabel">Confirm</h4>
		  </div>
		  <form role="form" action="{{ abs_url }}" method="post">
			<div class="modal-body">
			  <p>Mark these cars as having been seen in the {{ query_descr }} search?</p>
			  <p>If you do, these cars will not be shown by default when you run this query again in the future. However, you can always display all matching cars, including ones marked as seen, by clicking on the 'All listings' button.)</p>
			  {% csrf_token %}
			  <input type="hidden" name="action" value="mark_read"/>
			  <input type="hidden" name="query_ref" value="{{ query_ref }}"/>
			  <input type="hidden" name="query_date" value="{{ timestamp }}"/>
			</div>
			<div class="modal-footer">
			  <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
			  <button type="submit" class="btn btn-primary">Confirm</button>
			</div>
		  </form>		
		</div>
	  </div>
	</div>
	<div class="modal fade" id="favCarModal" tabindex="-1" role="dialog" aria-labelledby="favCarModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
			<h4 class="modal-title" id="favCarModalLabel">Saved!</h4>
		  </div>
		  <div class="modal-body">
			<p>You have added this <span id='favcartitle'>car</span> to your favorite cars list.</p>
			<p>You can view your favorite cars at any time on your <a href="/dashboard">dashboard</a>.</p>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
		  </div>
		</div>
	  </div>
	</div>
	<div class="modal fade" id="unFavCarModal" tabindex="-1" role="dialog" aria-labelledby="unFavCarModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
			<h4 class="modal-title" id="unFavCarModalLabel">Confirm</h4>
		  </div>
		  <form role="form" id="unfavform" action="/ajax/unsavecar" method="post">
			<div class="modal-body">
			  <p>Really remove this <span id='unfavcartitle'>car</span> from your favorite cars list?</p>
			  <p>You can view your favorite cars at any time on your <a href="/dashboard">dashboard</a>.</p>
			  {% csrf_token %}
			  <input type="hidden" name="listing_id" id="unfavlisting_id" value=""/>
			</div>
			<div class="modal-footer">
			  <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
			  <button type="submit" class="btn btn-primary">Confirm</button>
			</div>
		  </form>
		</div>
	  </div>
	</div>
	<div class="modal fade" id="editNoteModal" tabindex="-1" role="dialog" aria-labelledby="editNoteModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
			<h4 class="modal-title" id="editNoteModalLabel">Notes</h4>
		  </div>
		  <form role="form" id="noteform" action="/ajax/addnote" method="post">
			<div class="modal-body">
			  <p>Add your notes about this <span id='notecartitle'>car</span>. These notes are private, visible only to you:</p>
			  {% csrf_token %}
			  <input type="hidden" name="listing_id" id="notelisting_id" value=""/>
			  <div class="modal-input">
				<textarea rows="5" cols="50" name="listing_note" id="note_text" value=""></textarea>
			  </div>
			</div>
			<div class="modal-footer">
			  <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
			  <button type="submit" class="btn btn-primary">Confirm</button>
			</div>
		  </form>		
		</div>
	  </div>
	</div>
	<div class="modal fade" id="flagCarModal" tabindex="-1" role="dialog" aria-labelledby="flagCarModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
			<h4 class="modal-title" id="flagCarModalLabel">Confirm</h4>
		  </div>
		  <form role="form" id="flagform" action="/ajax/flagcar" method="post">
			<div class="modal-body">
			  <p>You are flagging this <span id='flagcartitle'>car</span> listing.</p>
			  <p>It will no longer appear in any of your query results.</p>
			  <p>Carbyr also uses this information to filter postings and improve the quality of current and future results. Can you please let us know why you are flagging this listing?</p>
			  {% csrf_token %}
			  <input type="hidden" name="listing_id" id="flaglisting_id" value=""/>
			  <div class="radio modal-input">
				<label>
				  <input type="radio" name="reason" id="reason_uninteresting" value="U" checked>
				  Just not interesting
				</label>
			  </div>
			  <div class="radio modal-input">
				<label>
				  <input type="radio" name="reason" id="reason_noncar" value="N">
				  Not a car listing
				</label>
			  </div>
			  <div class="radio modal-input">
				<label>
				  <input type="radio" name="reason" id="reason_incorrect" value="I">
				  Incorrect or misleading information
				</label>
			  </div>
			  <div class="radio modal-input">
				<label>
				  <input type="radio" name="reason" id="reason_fraud" value="F">
				  Suspected fraud
				</label>
			  </div>
			  <div class="radio modal-input">
				<label>
				  <input type="radio" name="reason" id="reason_sold" value="S">
				  Sold or no longer available
				</label>
			  </div>
			  <div class="radio modal-input">
				<label>
				  <input type="radio" name="reason" id="reason_other" value="O">
				  Other: <input type="text" name="other_reason" value=""/>
				</label>
			  </div>
			</div>
			<div class="modal-footer">
			  <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
			  <button type="submit" class="btn btn-primary">Confirm</button>
			</div>
		  </form>		
		</div>
	  </div>
	</div>
	{% endblock dialogs %}
